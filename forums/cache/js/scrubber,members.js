
var ETScrubber={header:null,body:null,scrubber:null,items:null,loadItemsCallback:null,scrollToIndexCallback:null,count:0,startFrom:0,perPage:0,moreText:"Load more",loadedItems:[],init:function(){var count=Math.min(this.startFrom+this.perPage,this.count);for(var i=this.startFrom;i<count;i++)
this.loadedItems.push(i);this.header=$("#hdr");var headerTop=this.header.offset().top;var headerWidth=this.header.width();var scrubberTop=this.scrubber.length&&(this.scrubber.offset().top-this.header.outerHeight()-20);$(window).scroll(function(){var y=$(this).scrollTop();$("> li",ETScrubber.items).each(function(){var item=$(this);if(y>item.offset().top+item.outerHeight()-ETScrubber.header.outerHeight())return true;else if(item.data("index")){$(".scrubber li").removeClass("selected");var index=item.data("index");$(".scrubber-"+index,ETScrubber.scrubber).addClass("selected").parents("li").addClass("selected");return false;}});var newer=$(".scrubberNext",ETScrubber.body);if(newer.length&&y+$(window).height()>newer.offset().top&&!newer.hasClass("loading")&&!ET.disableFixedPositions){newer.find("a").click();}}).scroll();$(ETScrubber.body).on("click",".scrubberMore a",function(e){e.preventDefault();$(this).parent().addClass("loading");var moreItem=$(this).parent();var backwards,position;if(moreItem.is(".scrubberPrevious")){backwards=true;position=Math.min.apply(Math,ETScrubber.loadedItems)-ETScrubber.perPage;}
else if(moreItem.is(".scrubberNext")){backwards=false;position=Math.max.apply(Math,ETScrubber.loadedItems)+1;}
else{backwards=moreItem.offset().top-$(document).scrollTop()<250;position=backwards?$(this).parent().data("positionEnd")-ETScrubber.perPage+1:$(this).parent().data("positionStart");}
ETScrubber.loadItemsCallback(position,function(data){if(backwards){var firstItem=moreItem.next();var scrollOffset=firstItem.offset().top-$(document).scrollTop();}
var items=ETScrubber.addItems(data.startFrom,data.view,moreItem);if(backwards)
$.scrollTo(firstItem.offset().top-scrollOffset);return items;});});$(".scrubber a",ETScrubber.scrubber).click(function(e){e.preventDefault();var index=$(this).parent().data("index");if(index=="last")index=Infinity;else if(index=="first")index=0;var found=ETScrubber.scrollToIndex(index);if(!found){var moreItem=null,prevPost=null;$("li",ETScrubber.items).each(function(){if($(this).is(".scrubberMore"))moreItem=$(this);else{var item=$(this).first();if(item.data("index")>index)return false;moreItem=null;prevPost=$(this);}});if(!moreItem&&!prevPost)
ETScrubber.scrollTo(0);else if(!moreItem&&prevPost&&index!=Infinity)
ETScrubber.scrollTo(prevPost.offset().top);else if(moreItem){ETScrubber.scrollTo(moreItem.offset().top);moreItem.addClass("loading");ETScrubber.loadItemsCallback(index,function(data){if(index==Infinity){$('html,body').stop(true,true);var scrollOffset=ETScrubber.items.offset().top+ETScrubber.items.outerHeight()-$(document).scrollTop();}
var items=ETScrubber.addItems(data.startFrom,data.view,moreItem);if(index==Infinity)$.scrollTo(ETScrubber.items.offset().top+ETScrubber.items.outerHeight()-scrollOffset);else ETScrubber.scrollToIndex(index);return items;},true);}}});},scrollTo:function(position){$.scrollTo(Math.max(0,position-ETScrubber.header.outerHeight()-20),"slow");},scrollToIndex:function(index){var post=null,found=false,item;$("li",ETScrubber.items).each(function(){item=$(this);if(item.data("index")==index){found=true;return false;}
if(item.data("index")>index)
return false;});if(item)ETScrubber.scrollTo(index==0?0:$(item).offset().top);if(typeof ETScrubber.scrollToIndexCallback=="function")ETScrubber.scrollToIndexCallback(index);return found;},addItems:function(startFrom,items,moreItem,animate){startFrom=parseInt(startFrom);moreItem.removeClass("loading");var view=$(items);view=view.filter("li");var items=[],newStartFrom=startFrom;for(var i=0;i<ETScrubber.perPage;i++){if(startFrom+i>=ETScrubber.count)break;if(ETScrubber.loadedItems.indexOf(startFrom+i)!=-1){if(items.length)break;newStartFrom=startFrom+i+1;continue;}
items.push(view[i]);}
startFrom=newStartFrom;items=$(items);if($("div.timeMarker[data-now]",ETScrubber.body).length){items.find("div.timeMarker[data-now]").remove();}
if(moreItem.is(".scrubberPrevious"))
moreItem.after(items);else if(moreItem.is(".scrubberNext"))
moreItem.before(items);else if(items.length)
moreItem.replaceWith(items);var scrubberMore=$("<li class='scrubberMore'><a href='#'>"+ETScrubber.moreText+"</a></li>");if(ETScrubber.loadedItems.indexOf(startFrom-1)==-1&&items.first().prev().is("li:not(.scrubberMore)")){scrubberMore=scrubberMore.clone();items.first().before(scrubberMore);for(var i=startFrom-1;i>0;i--){if(ETScrubber.loadedItems.indexOf(i)!=-1)break;}
scrubberMore.data("positionStart",i+1);scrubberMore.data("positionEnd",startFrom-1);}
if(ETScrubber.loadedItems.indexOf(startFrom+items.length)==-1&&items.last().next().is("li:not(.scrubberMore)")){scrubberMore=scrubberMore.clone();items.last().after(scrubberMore);for(var i=startFrom+items.length+1;i<ETScrubber.count;i++){if(ETScrubber.loadedItems.indexOf(i)!=-1)break;}
scrubberMore.data("positionStart",startFrom+items.length);scrubberMore.data("positionEnd",i-1);}
if(animate)items.hide().fadeIn("slow");for(var i=startFrom;i<startFrom+items.length;i++){if(ETScrubber.loadedItems.indexOf(i)==-1)
ETScrubber.loadedItems.push(i);}
if(Math.min.apply(Math,ETScrubber.loadedItems)<=0)
$(".scrubberPrevious").remove();if(Math.max.apply(Math,ETScrubber.loadedItems)>=ETScrubber.count-1)
$(".scrubberNext").remove();return items;}};var ETMembers={init:function(){$("#createMemberLink").click(function(e){e.preventDefault();ETMembers.loadCreateMemberSheet();});var selected=$("#memberListOrderBy").find(".selected").removeClass("selected").find("a").prepend("<i class='icon-ok'></i>");$(".scrubberContent").prepend($("#memberListOrderBy").removeClass("tabs").popup({alignment:"right",content:T("Sort By")+" "+selected.text()+" <i class='icon-caret-down'></i>"}).find(".button").addClass("big").end());ETScrubber.body=$("#memberListBody");ETScrubber.scrubber=$("#members .scrubberContent");ETScrubber.items=$("#memberList");ETScrubber.count=parseInt(ET.countMembers);ETScrubber.perPage=parseInt(ET.membersPerPage);ETScrubber.moreText=T("Load more members");ETScrubber.startFrom=parseInt(ET.startFrom);ETScrubber.loadItemsCallback=function(position,success){$.ETAjax({url:"members/index.ajax/"+ET.orderBy+"/"+position,data:{search:ET.searchString},success:success,global:false});};ETScrubber.scrollToIndexCallback=function(index){$.history.load("members/"+ET.orderBy+"/"+index,true);};ETScrubber.init();$("#memberList .online").tooltip({alignment:"left",className:"withArrow withArrowBottom",offset:[-9,0]}).css("cursor","pointer");ETMembers.formInput=$("#memberSearch input[name=search]");$("#gambits").hide();$("#memberSearch input[name=search]").blur(function(){$("#gambits").fadeOut("fast");}).focus(function(){var input=$("#memberSearch input[name=search]");$("#gambits").addClass("popup").css({position:"absolute",top:input.offset().top+input.outerHeight()+5,left:input.offset().left}).fadeIn("fast");});$("#gambits").mousedown(function(e){e.preventDefault();});$("#gambits a").click(function(e){e.preventDefault();ETMembers.gambit(desanitize($(this).data("gambit")));}).dblclick(function(e){e.preventDefault();ETMembers.formInput.val(desanitize($(this).data("gambit")));$("#memberSearch").submit();}).bind("mousedown",function(e){e.preventDefault();});},gambit:function(gambit){var initialLength=$.trim(ETMembers.formInput.val()).length;var safe=gambit.replace(/([?^():\[\]])/g,"\\$1");var regexp=new RegExp("( ?\\+ *"+safe+" *$|^ *"+safe+" *\\+ ?| ?\\+ *"+safe+"|^ *"+safe+" *$)","i");if(ETMembers.formInput.val().match(regexp))ETMembers.formInput.val(ETMembers.formInput.val().replace(regexp,""));else{var insert=(initialLength?" + ":"")+gambit;ETMembers.formInput.focus();ETMembers.formInput.val(ETMembers.formInput.val()+insert);var placeholderIndex,placeholder;if(insert.indexOf("?")!=-1){placeholderIndex=insert.indexOf("?");placeholder="?";}
if(placeholderIndex){ETMembers.formInput.selectRange(initialLength+placeholderIndex,initialLength+placeholderIndex+placeholder.length);}}},loadCreateMemberSheet:function(formData){ETSheet.loadSheet("createMemberSheet","members/create.view",function(){$(this).find("form").ajaxForm("submit",ETMembers.loadCreateMemberSheet);},formData);}};$(function(){ETMembers.init();});